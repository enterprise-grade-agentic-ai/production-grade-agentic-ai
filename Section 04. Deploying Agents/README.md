# üöÄ Section 04. Deploying Agents

## üéØ Purpose
This sections focuses on deploying Agents to AgentCore Runtime. Demos in the course included configuring AgentCore runtime, and then deploying, and finally invoking it by providing a research topic. This repo contains the code used for the demos.

## üõ†Ô∏è Installation
This project uses [UV](https://docs.astral.sh/uv/) for dependency management and package handling, offering a seamless setup and execution experience.

First, if you haven't already, install uv:
```bash
pip install uv
```

Next, navigate to your project directory and install the dependencies:
```bash
uv sync
```

## ‚úÖ Pre-requisites
___Instead of automating the pre-requisites, most of the steps are kept as manual. This has been intentionally done so that the learner can grasp the concepts in more detail.___

### AWS CLI Setup
___If not already done in the previous sections___, you may follow below steps to setup AWS CLI:
1. Install AWS CLI using [User Guide](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
2. Configure AWS CLI using the below command on the terminal. Try to keep region as `us-east-1` as it generally gets the latest updates.
```bash
aws configure 
```
Note: The AWS key or user used in `aws configure` command should have read and write permissions for AWS Bedrock, AgentCore Runtime, AgentCore Memory, AgentCore MCP, AWS Cognito, and AWS Secrets Manager.

### Env file setup
___If not already done in the previous sections___, you may copy `.env.template` as `.env` and populate it as mentioned in the subsequent steps.

### AWS Secrets Manager Setup (Optional)
We are talking about production grade agentic AI. Which means we shouldn't have secrets sprinkled in the local environment file or code. To ensure this security best practice, ideally you should create a secret in AWS secrets manager of type `Other type of secret`. You can populate secrets like `OpenAI key` in this container secret as key value pair. Key is the secret name, and value is the secret value. You needn't populate secrets in it as of now. AWS might stop you from saving the secret without any key value. You may save a dummy key value just to proceed.

After that set below variables in the `.env` file present in the current folder:
```python
SECRET_NAME=<Name of the secret as created in the AWS Secrets Manager>
SECRET_REGION=<AWS region where this secret is created, e.g. us-east-1>
```
The code is already in place to load the secrets from this container into environment file. Please note that secrets stored in AWS secrets manager costs. If you wouldn't like to incur that cost, you may set secrets in the local `.env` file. In that case, for security reasons, you should only try out the agentic application on local machine only.

### OpenAI Setup (Only if using OpenAI models)
:memo: This repo by default uses Amazon's Nova Pro model. But in my personal experience, OpenAI's gpt models perform better. You may consider setting up OpenAI for this repo if your budget allows.

___If not already done in the previous sections___, and you would like to use OpenAI models, you may follow below steps.
1. Generate OpenAI key if you would like to use OpenAI models. This can be done on [OpenAI Platform](https://platform.openai.com/). Please note that using OpenAI models would require minimum payment of $5 to OpenAI.
2. Set below key in the AWS secret containing secrets. This would be automatically loaded in the environment variables of the application. If you are not using AWS secret and just trying on you local, you may set this in `.env` file. 
```python
OPENAI_API_KEY=<Key as generated by OpenAI>
```

### üÜï AWS Cognito Setup
___This is a new pre-requisite introduced in this section___. You may setup cognito for authentication using the below steps:
1. To setup AWS Cognito, you may run:
```bash
sh miscellaneous/cognitoSetup.sh 
```
Please note down `Discovery URL` and `Client ID` as printed on the terminal.

### üÜï AWS AgentCore Runtime Setup
___This is a new pre-requisite introduced in this section___. You may setup AWS AgentCore using the below steps:
1. Deploy the `agentcore` CLI
2. Configure the AgentCore runtime. You may use below command for the same.
```bash
sh agentCoreConfigure.sh
```
This command is an interactive one. It will ask for more inputs, you may provide details as below. You may just accept default values for other inputs.
* üìÇ Entrypoint Selection: `src/emergingtechnologyresearch/agentCoreHandler.py`
* üè∑Ô∏è Agent Name: `emergingtechnologyresearch`
* üîç Detected dependency file: `pyproject.toml`
* üöÄ Deployment Configuration -> Deployment type: `Container`
* üîê Authorization Configuration: `OAuth`
* üìã OAuth Configuration
  * OAuth discovery URL: `<Discovery URL as copied in AWS Cognito setup>`
  * Allowed OAuth client IDs: `<Client ID as copied in AWS Cognito setup>`

This creates `.bedrock_agentcore.yaml`. You may explore this YAML file.

3. If the previous configuration step was successful, you may now proceed with the deployment. The deployment can be done using the below command. It will also pick all environment variables in the `.env` file and pass it along to the `agentcore deploy` command.
```bash
sh agentCoreDeploy.sh
```
4. _Optional Step if you have not setup AWS Secrets containing secrets_. If the deployment in the previous step was successful, and if you have setup a secret in AWS Secrets Manager using one of the steps above, you may go to AWS AgentCore Runtime and modify its IAM execution role, and add below permissions. This will allow the Runtime to read the secrets from AWS Secrets Manager. Do remember to change the secret ARN in the below JSON.
```json
{
    "Sid": "ReadSecret",
    "Effect": "Allow",
    "Action": [
        "secretsmanager:GetSecretValue"
    ],
    "Resource": [
        "<ARN of the secret created in AWS Secrets Manager>"
    ]
}
```

## üöÄ Running the Project
To see AgentCore runtime in action, you may use below steps:
1. Generate a bearer token to invoke AgentCore runtime using the below command on terminal:
```bash
export TOKEN=$(aws cognito-idp initiate-auth \
            --client-id "<Client ID created as part of AWS Cognito setup>" \
            --auth-flow USER_PASSWORD_AUTH \
            --auth-parameters USERNAME='agenticLearner',PASSWORD='helloAgentic' \
            --region us-east-1 | jq -r '.AuthenticationResult.AccessToken')
```
2. Invoke the AgentCore runtime using the below command on terminal:
```bash
agentcore invoke '{"topic": "<Topic of your choice>"}' --bearer-token $TOKEN
```
3. Do remember to explore the sessionId and other details returned by the `AgentCore invoke` command.
4. Now you may explore the runtime created by visiting AWS AgentCore Console. You may observe its version management, auth configurations and more details.
5. It is also important to explore cloudwatch for AgentCore metrics as well as traces (very similar way to Langfuse).

**Happy Learning! üéâü§ñ**
